// ============================================
// SISTEMA GDB BENI - VERSI√ìN DEFINITIVA 5.0
// TOTALMENTE COMPATIBLE CON GITHUB PAGES
// ============================================

// CONFIGURACI√ìN - NOMBRES DE HOJAS
const CONFIG = {
  sheetNames: {
    credenciales: 'Credenciales',
    logs: 'Logs',
    configuracion: 'Configuracion',
    detalles: 'DetallesUsuarios',
    actividades: 'ActividadesGDB'
  }
};

// MAPA DE COLUMNAS (Columna A=0, B=1, C=2, etc.)
const COLUMNAS = {
  CREDENCIALES: {
    ID: 0,                 // A
    EMAIL: 1,              // B
    PASSWORD_HASH: 2,      // C
    SALT: 3,               // D
    TIPO_USUARIO: 4,       // E
    ACTIVO: 5,             // F
    FECHA_CREACION: 6,     // G
    ULTIMO_ACCESO: 7,      // H
    TOKEN_RECUPERACION: 8  // I
  },
  LOGS: {
    TIMESTAMP: 0,
    ID_USUARIO: 1,
    EMAIL: 2,
    ACCION: 3,
    EXITOSO: 4,
    DETALLES: 5
  }
};

// ============================================
// 1. FUNCI√ìN PRINCIPAL: DOGET (PARA GITHUB PAGES)
// ============================================

function doGet(e) {
  const params = e.parameter || {};
  const callback = params.callback || 'callback';
  const action = params.action;
  
  let respuesta;
  
  try {
    switch(action) {
      case 'login':
        respuesta = autenticarUsuario(params.email, params.password);
        break;
        
      case 'getUserData':
        respuesta = obtenerPerfilCompleto(params.userId, params.sessionToken);
        break;
        
      case 'verifyPassword':
        respuesta = verificarContrase√±a(params.userId, params.password);
        break;
        
      case 'status':
        respuesta = {
          success: true,
          status: 'online',
          version: '5.0.0',
          system: 'GDB Beni',
          timestamp: new Date().toISOString()
        };
        break;
        
      default:
        respuesta = {
          success: true,
          message: 'Servidor GDB funcionando',
          url: ScriptApp.getService().getUrl(),
          allowedOrigins: ['https://diplomacianacional.github.io', 'http://localhost:5500']
        };
    }
  } catch(error) {
    respuesta = {
      success: false,
      error: error.message
    };
  }
  
  // üî• CLAVE: Configurar encabezados CORS expl√≠citamente
  const output = ContentService.createTextOutput();
  
  // Para JSONP (cuando hay callback)
  if (params.callback) {
    output.setContent(callback + '(' + JSON.stringify(respuesta) + ')');
    output.setMimeType(ContentService.MimeType.JAVASCRIPT);
  } 
  // Para fetch normal (cuando no hay callback)
  else {
    output.setContent(JSON.stringify(respuesta));
    output.setMimeType(ContentService.MimeType.JSON);
  }
  
  // üî• A√ëADIR ENCABEZADOS CORS EXPL√çCITOS
  output.setHeaders({
    'Access-Control-Allow-Origin': '*', // Permite GitHub Pages
    'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type',
    'Access-Control-Max-Age': '86400'
  });
  
  return output;
}

// Funci√≥n OPTIONS para preflight requests
function doOptions(e) {
  const output = ContentService.createTextOutput();
  
  output.setHeaders({
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type',
    'Access-Control-Max-Age': '86400'
  });
  
  return output;
}

// ============================================
// 2. AUTENTICACI√ìN DE USUARIO
// ============================================

function autenticarUsuario(email, password) {
  console.log(`üîê Autenticando: ${email}`);
  
  // Validaci√≥n b√°sica
  if (!email || !password) {
    return {
      success: false,
      error: 'Email y contrase√±a son requeridos'
    };
  }
  
  try {
    const emailLimpio = email.trim().toLowerCase();
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const hojaCredenciales = spreadsheet.getSheetByName(CONFIG.sheetNames.credenciales);
    
    if (!hojaCredenciales) {
      return {
        success: false,
        error: 'Error de configuraci√≥n del sistema'
      };
    }
    
    // Obtener datos de la hoja
    const datos = hojaCredenciales.getDataRange().getValues();
    
    // Buscar usuario por email
    for (let filaIndex = 1; filaIndex < datos.length; filaIndex++) {
      const fila = datos[filaIndex];
      const idUsuario = fila[COLUMNAS.CREDENCIALES.ID];
      const emailUsuario = fila[COLUMNAS.CREDENCIALES.EMAIL];
      const hashAlmacenado = fila[COLUMNAS.CREDENCIALES.PASSWORD_HASH];
      const saltAlmacenado = fila[COLUMNAS.CREDENCIALES.SALT];
      const tipoUsuario = fila[COLUMNAS.CREDENCIALES.TIPO_USUARIO] || 'delegado';
      const activo = esValorVerdadero(fila[COLUMNAS.CREDENCIALES.ACTIVO]);
      
      if (!emailUsuario) continue;
      
      // Verificar email
      if (emailUsuario.toString().trim().toLowerCase() === emailLimpio) {
        
        // Verificar si la cuenta est√° activa
        if (!activo) {
          registrarLogSistema(idUsuario, emailLimpio, 'LOGIN', false, 'Cuenta inactiva');
          return {
            success: false,
            error: 'Tu cuenta est√° inactiva. Contacta al administrador.'
          };
        }
        
        // Verificar contrase√±a
        const hashIngresado = generarHashContrasena(password, saltAlmacenado);
        
        if (hashIngresado === hashAlmacenado) {
          // Actualizar √∫ltimo acceso
          const fechaAcceso = new Date().toISOString();
          hojaCredenciales.getRange(filaIndex + 1, COLUMNAS.CREDENCIALES.ULTIMO_ACCESO + 1)
                         .setValue(fechaAcceso);
          
          // Registrar login exitoso
          registrarLogSistema(idUsuario, emailLimpio, 'LOGIN', true, 'Acceso exitoso');
          
          // Obtener informaci√≥n del usuario
          const nombreMostrar = extraerNombreDesdeEmail(emailLimpio);
          const iniciales = obtenerIniciales(nombreMostrar);
          
          // Generar token de sesi√≥n
          const tokenSesion = generarTokenDeSesion(idUsuario);
          
          return {
            success: true,
            message: '¬°Bienvenido a GDB Beni!',
            data: {
              id: idUsuario,
              email: emailLimpio,
              nombre: nombreMostrar,
              tipo: tipoUsuario,
              iniciales: iniciales,
              sessionToken: tokenSesion,
              timestamp: Date.now(),
              expiracion: Date.now() + (24 * 60 * 60 * 1000) // 24 horas
            }
          };
          
        } else {
          // Contrase√±a incorrecta
          registrarLogSistema(idUsuario, emailLimpio, 'LOGIN', false, 'Contrase√±a incorrecta');
          return {
            success: false,
            error: 'Contrase√±a incorrecta'
          };
        }
      }
    }
    
    // Usuario no encontrado
    registrarLogSistema(null, emailLimpio, 'LOGIN', false, 'Email no registrado');
    return {
      success: false,
      error: 'Email no registrado en el sistema'
    };
    
  } catch (error) {
    console.error('‚ùå Error en autenticarUsuario:', error);
    registrarLogSistema(null, email, 'LOGIN_ERROR', false, error.toString());
    
    return {
      success: false,
      error: 'Error en el servidor. Intenta nuevamente.'
    };
  }
}

// ============================================
// 3. OBTENER PERFIL COMPLETO DEL USUARIO
// ============================================

function obtenerPerfilCompleto(usuarioId, tokenSesion) {
  console.log(`üë§ Obteniendo perfil para ID: ${usuarioId}`);
  
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    
    // 1. Obtener datos b√°sicos de credenciales
    const hojaCredenciales = spreadsheet.getSheetByName(CONFIG.sheetNames.credenciales);
    
    if (!hojaCredenciales) {
      return {
        success: false,
        error: 'Sistema no configurado correctamente'
      };
    }
    
    const datosCredenciales = hojaCredenciales.getDataRange().getValues();
    let datosUsuario = null;
    
    // Buscar usuario por ID
    for (let filaIndex = 1; filaIndex < datosCredenciales.length; filaIndex++) {
      if (parseInt(datosCredenciales[filaIndex][COLUMNAS.CREDENCIALES.ID]) === parseInt(usuarioId)) {
        datosUsuario = {
          id: datosCredenciales[filaIndex][COLUMNAS.CREDENCIALES.ID],
          email: datosCredenciales[filaIndex][COLUMNAS.CREDENCIALES.EMAIL],
          tipo: datosCredenciales[filaIndex][COLUMNAS.CREDENCIALES.TIPO_USUARIO] || 'delegado',
          activo: esValorVerdadero(datosCredenciales[filaIndex][COLUMNAS.CREDENCIALES.ACTIVO]),
          fechaRegistro: datosCredenciales[filaIndex][COLUMNAS.CREDENCIALES.FECHA_CREACION],
          ultimoAcceso: datosCredenciales[filaIndex][COLUMNAS.CREDENCIALES.ULTIMO_ACCESO]
        };
        break;
      }
    }
    
    if (!datosUsuario) {
      return {
        success: false,
        error: 'Usuario no encontrado'
      };
    }
    
    // 2. Obtener nombre e iniciales
    datosUsuario.nombre = extraerNombreDesdeEmail(datosUsuario.email);
    datosUsuario.iniciales = obtenerIniciales(datosUsuario.nombre);
    
    // 3. Obtener detalles adicionales
    const detalles = obtenerDetallesAdicionales(usuarioId);
    datosUsuario = { ...datosUsuario, ...detalles };
    
    // 4. Obtener estad√≠sticas
    datosUsuario.estadisticas = obtenerEstadisticasParticipacion(usuarioId);
    
    // 5. Obtener actividades recientes
    datosUsuario.actividadesRecientes = obtenerActividadesRecientes(usuarioId);
    
    return {
      success: true,
      message: 'Perfil obtenido exitosamente',
      data: datosUsuario
    };
    
  } catch (error) {
    console.error('‚ùå Error en obtenerPerfilCompleto:', error);
    return {
      success: false,
      error: 'Error al obtener perfil: ' + error.message
    };
  }
}

// ============================================
// 4. ACTUALIZAR PERFIL DEL USUARIO
// ============================================

function actualizarPerfilUsuario(usuarioId, datosActualizados, tokenSesion) {
  console.log(`‚úèÔ∏è Actualizando perfil ID: ${usuarioId}`);
  
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    
    // Asegurar que existe la hoja de detalles
    let hojaDetalles = spreadsheet.getSheetByName(CONFIG.sheetNames.detalles);
    if (!hojaDetalles) {
      crearHojaDetallesUsuariosCompleta();
      hojaDetalles = spreadsheet.getSheetByName(CONFIG.sheetNames.detalles);
    }
    
    const datos = hojaDetalles.getDataRange().getValues();
    let filaIndex = -1;
    
    // Buscar usuario en detalles
    for (let i = 1; i < datos.length; i++) {
      if (parseInt(datos[i][0]) === parseInt(usuarioId)) {
        filaIndex = i;
        break;
      }
    }
    
    if (filaIndex === -1) {
      // Crear nueva entrada
      const nuevaFila = [
        usuarioId,
        datosActualizados.nombreCompleto || '',
        datosActualizados.fechaNacimiento || '',
        datosActualizados.telefono || '',
        datosActualizados.whatsapp || '',
        datosActualizados.departamento || 'Beni',
        datosActualizados.ciudad || 'Trinidad',
        datosActualizados.institucion || 'GDB Beni',
        datosActualizados.carrera || '',
        datosActualizados.semestre || '',
        datosActualizados.genero || '',
        datosActualizados.facebook || '',
        datosActualizados.instagram || '',
        datosActualizados.biografia || 'Miembro de GDB Beni',
        '', // FotoURL
        datosActualizados.intereses || 'Diplomacia, Liderazgo',
        datosActualizados.habilidades || 'Comunicaci√≥n',
        datosActualizados.idiomas || 'Espa√±ol',
        new Date().toISOString(), // FechaRegistro
        new Date().toISOString()  // FechaActualizacion
      ];
      
      hojaDetalles.appendRow(nuevaFila);
      
    } else {
      // Actualizar entrada existente
      const filaNum = filaIndex + 1;
      
      // Actualizar cada campo si est√° presente en datosActualizados
      if (datosActualizados.nombreCompleto !== undefined) {
        hojaDetalles.getRange(filaNum, 2).setValue(datosActualizados.nombreCompleto);
      }
      if (datosActualizados.fechaNacimiento !== undefined) {
        hojaDetalles.getRange(filaNum, 3).setValue(datosActualizados.fechaNacimiento);
      }
      if (datosActualizados.telefono !== undefined) {
        hojaDetalles.getRange(filaNum, 4).setValue(datosActualizados.telefono);
      }
      if (datosActualizados.whatsapp !== undefined) {
        hojaDetalles.getRange(filaNum, 5).setValue(datosActualizados.whatsapp);
      }
      if (datosActualizados.departamento !== undefined) {
        hojaDetalles.getRange(filaNum, 6).setValue(datosActualizados.departamento);
      }
      if (datosActualizados.ciudad !== undefined) {
        hojaDetalles.getRange(filaNum, 7).setValue(datosActualizados.ciudad);
      }
      if (datosActualizados.institucion !== undefined) {
        hojaDetalles.getRange(filaNum, 8).setValue(datosActualizados.institucion);
      }
      if (datosActualizados.carrera !== undefined) {
        hojaDetalles.getRange(filaNum, 9).setValue(datosActualizados.carrera);
      }
      if (datosActualizados.semestre !== undefined) {
        hojaDetalles.getRange(filaNum, 10).setValue(datosActualizados.semestre);
      }
      if (datosActualizados.genero !== undefined) {
        hojaDetalles.getRange(filaNum, 11).setValue(datosActualizados.genero);
      }
      if (datosActualizados.facebook !== undefined) {
        hojaDetalles.getRange(filaNum, 12).setValue(datosActualizados.facebook);
      }
      if (datosActualizados.instagram !== undefined) {
        hojaDetalles.getRange(filaNum, 13).setValue(datosActualizados.instagram);
      }
      if (datosActualizados.biografia !== undefined) {
        hojaDetalles.getRange(filaNum, 14).setValue(datosActualizados.biografia);
      }
      if (datosActualizados.intereses !== undefined) {
        hojaDetalles.getRange(filaNum, 16).setValue(datosActualizados.intereses);
      }
      if (datosActualizados.habilidades !== undefined) {
        hojaDetalles.getRange(filaNum, 17).setValue(datosActualizados.habilidades);
      }
      if (datosActualizados.idiomas !== undefined) {
        hojaDetalles.getRange(filaNum, 18).setValue(datosActualizados.idiomas);
      }
      
      // Actualizar fecha de modificaci√≥n
      hojaDetalles.getRange(filaNum, 20).setValue(new Date().toISOString());
    }
    
    registrarLogSistema(usuarioId, 'N/A', 'UPDATE_PROFILE', true, 'Perfil actualizado');
    
    return {
      success: true,
      message: 'Perfil actualizado correctamente'
    };
    
  } catch (error) {
    console.error('‚ùå Error actualizando perfil:', error);
    registrarLogSistema(usuarioId, 'N/A', 'UPDATE_PROFILE', false, error.toString());
    
    return {
      success: false,
      error: 'Error al actualizar perfil: ' + error.message
    };
  }
}

// ============================================
// 5. CAMBIAR CONTRASE√ëA
// ============================================

// ============================================
// 5. CAMBIAR CONTRASE√ëA (ACTUALIZADA CON TU ESTRUCTURA)
// ============================================

function cambiarContrase√±aUsuarioWeb(usuarioId, currentPassword, newPassword, sessionToken) {
  console.log(`üîê Cambiando contrase√±a para ID: ${usuarioId}`);
  
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const hojaCredenciales = spreadsheet.getSheetByName(CONFIG.sheetNames.credenciales);
    
    if (!hojaCredenciales) {
      return {
        success: false,
        error: 'Hoja de credenciales no encontrada'
      };
    }
    
    const datos = hojaCredenciales.getDataRange().getValues();
    let filaIndex = -1;
    let emailUsuario = '';
    
    // Buscar usuario por ID
    for (let i = 1; i < datos.length; i++) {
      if (parseInt(datos[i][COLUMNAS.CREDENCIALES.ID]) === parseInt(usuarioId)) {
        filaIndex = i;
        emailUsuario = datos[i][COLUMNAS.CREDENCIALES.EMAIL];
        break;
      }
    }
    
    if (filaIndex === -1) {
      return {
        success: false,
        error: 'Usuario no encontrado'
      };
    }
    
    // Obtener datos del usuario
    const hashAlmacenado = datos[filaIndex][COLUMNAS.CREDENCIALES.PASSWORD_HASH];
    const saltAlmacenado = datos[filaIndex][COLUMNAS.CREDENCIALES.SALT];
    
    // Verificar contrase√±a actual
    const hashIngresado = generarHashContrasena(currentPassword, saltAlmacenado);
    
    if (hashIngresado !== hashAlmacenado) {
      // Tambi√©n verificar contrase√±a temporal
      const passwordTemporal = usuarioId.toString().padStart(4, '0') + 'GDB';
      const hashTemporal = generarHashContrasena(passwordTemporal, saltAlmacenado);
      
      if (hashTemporal !== hashIngresado) {
        registrarLogSistema(usuarioId, emailUsuario, 'CHANGE_PASSWORD', false, 'Contrase√±a actual incorrecta');
        return {
          success: false,
          error: 'La contrase√±a actual es incorrecta'
        };
      }
    }
    
    // Validar nueva contrase√±a
    if (!newPassword || newPassword.length < 8) {
      return {
        success: false,
        error: 'La nueva contrase√±a debe tener al menos 8 caracteres'
      };
    }
    
    // Generar nuevo hash y salt
    const nuevoSalt = generarSaltAleatorio();
    const nuevoHash = generarHashContrasena(newPassword, nuevoSalt);
    
    // Actualizar en la hoja
    const filaNum = filaIndex + 1;
    
    hojaCredenciales.getRange(filaNum, COLUMNAS.CREDENCIALES.PASSWORD_HASH + 1)
                   .setValue(nuevoHash);
    hojaCredenciales.getRange(filaNum, COLUMNAS.CREDENCIALES.SALT + 1)
                   .setValue(nuevoSalt);
    
    // Registrar cambio
    registrarLogSistema(usuarioId, emailUsuario, 'CHANGE_PASSWORD', true, 'Contrase√±a actualizada exitosamente');
    
    return {
      success: true,
      message: '‚úÖ Contrase√±a actualizada exitosamente'
    };
    
  } catch (error) {
    console.error('‚ùå Error cambiando contrase√±a:', error);
    registrarLogSistema(usuarioId, 'N/A', 'CHANGE_PASSWORD_ERROR', false, error.toString());
    
    return {
      success: false,
      error: 'Error al cambiar contrase√±a: ' + error.message
    };
  }
}

// ============================================
// NUEVA FUNCI√ìN: verificarContrase√±a (para validaci√≥n)
// ============================================

function verificarContrase√±a(usuarioId, password) {
  console.log(`üîç Verificando contrase√±a para ID: ${usuarioId}`);
  
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const hojaCredenciales = spreadsheet.getSheetByName(CONFIG.sheetNames.credenciales);
    
    if (!hojaCredenciales) {
      return {
        success: false,
        error: 'Hoja de credenciales no encontrada'
      };
    }
    
    const datos = hojaCredenciales.getDataRange().getValues();
    
    // Buscar usuario por ID
    for (let i = 1; i < datos.length; i++) {
      if (parseInt(datos[i][COLUMNAS.CREDENCIALES.ID]) === parseInt(usuarioId)) {
        const hashAlmacenado = datos[i][COLUMNAS.CREDENCIALES.PASSWORD_HASH];
        const saltAlmacenado = datos[i][COLUMNAS.CREDENCIALES.SALT];
        
        // Verificar contrase√±a ingresada
        const hashIngresado = generarHashContrasena(password, saltAlmacenado);
        
        if (hashIngresado === hashAlmacenado) {
          return {
            success: true,
            message: 'Contrase√±a v√°lida'
          };
        }
        
        // Verificar contrase√±a temporal
        const passwordTemporal = usuarioId.toString().padStart(4, '0') + 'GDB';
        const hashTemporal = generarHashContrasena(passwordTemporal, saltAlmacenado);
        
        if (hashTemporal === hashIngresado) {
          return {
            success: true,
            message: 'Contrase√±a temporal v√°lida'
          };
        }
        
        return {
          success: false,
          error: 'Contrase√±a incorrecta'
        };
      }
    }
    
    return {
      success: false,
      error: 'Usuario no encontrado'
    };
    
  } catch (error) {
    console.error('‚ùå Error verificando contrase√±a:', error);
    return {
      success: false,
      error: 'Error en el servidor: ' + error.message
    };
  }
}

// ============================================
// 6. FUNCIONES AUXILIARES
// ============================================

function obtenerDetallesAdicionales(usuarioId) {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const hojaDetalles = spreadsheet.getSheetByName(CONFIG.sheetNames.detalles);
    
    if (!hojaDetalles) {
      return {
        nombreCompleto: 'Por completar',
        telefono: '',
        whatsapp: '',
        departamento: 'Beni',
        ciudad: 'Trinidad',
        institucion: 'GDB Beni',
        carrera: '',
        semestre: '',
        genero: '',
        facebook: '',
        instagram: '',
        biografia: 'Miembro de GDB Beni',
        fechaNacimiento: '',
        intereses: 'Diplomacia, Liderazgo',
        habilidades: 'Comunicaci√≥n',
        idiomas: 'Espa√±ol'
      };
    }
    
    const datos = hojaDetalles.getDataRange().getValues();
    
    for (let filaIndex = 1; filaIndex < datos.length; filaIndex++) {
      if (parseInt(datos[filaIndex][0]) === parseInt(usuarioId)) {
        return {
          nombreCompleto: datos[filaIndex][1] || '',
          fechaNacimiento: datos[filaIndex][2] || '',
          telefono: datos[filaIndex][3] || '',
          whatsapp: datos[filaIndex][4] || '',
          departamento: datos[filaIndex][5] || 'Beni',
          ciudad: datos[filaIndex][6] || 'Trinidad',
          institucion: datos[filaIndex][7] || 'GDB Beni',
          carrera: datos[filaIndex][8] || '',
          semestre: datos[filaIndex][9] || '',
          genero: datos[filaIndex][10] || '',
          facebook: datos[filaIndex][11] || '',
          instagram: datos[filaIndex][12] || '',
          biografia: datos[filaIndex][13] || 'Miembro de GDB Beni',
          fotoURL: datos[filaIndex][14] || '',
          intereses: datos[filaIndex][15] || 'Diplomacia, Liderazgo',
          habilidades: datos[filaIndex][16] || 'Comunicaci√≥n',
          idiomas: datos[filaIndex][17] || 'Espa√±ol',
          fechaRegistroDetalles: datos[filaIndex][18] || '',
          fechaActualizacion: datos[filaIndex][19] || ''
        };
      }
    }
    
    // Si no encontr√≥ detalles, retornar valores por defecto
    return {
      nombreCompleto: 'Por completar',
      telefono: '',
      whatsapp: '',
      departamento: 'Beni',
      ciudad: 'Trinidad',
      institucion: 'GDB Beni',
      carrera: '',
      semestre: '',
      genero: '',
      facebook: '',
      instagram: '',
      biografia: 'Miembro de GDB Beni',
      fechaNacimiento: '',
      intereses: 'Diplomacia, Liderazgo',
      habilidades: 'Comunicaci√≥n',
      idiomas: 'Espa√±ol'
    };
    
  } catch (error) {
    console.error('Error obteniendo detalles:', error);
    return {};
  }
}

function obtenerEstadisticasParticipacion(usuarioId) {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const hojaActividades = spreadsheet.getSheetByName(CONFIG.sheetNames.actividades);
    
    if (!hojaActividades) {
      return {
        eventosAsistidos: 0,
        horasVoluntariado: 0,
        proyectosParticipados: 0,
        puntosAcumulados: 0,
        ranking: 'Nuevo'
      };
    }
    
    const datos = hojaActividades.getDataRange().getValues();
    let eventos = 0, horas = 0, proyectos = 0, puntos = 0;
    
    for (let filaIndex = 1; filaIndex < datos.length; filaIndex++) {
      if (parseInt(datos[filaIndex][1]) === parseInt(usuarioId)) {
        eventos++;
        horas += parseFloat(datos[filaIndex][4]) || 0;
        puntos += parseInt(datos[filaIndex][6]) || 0;
        
        if (datos[filaIndex][3] === 'Proyecto') {
          proyectos++;
        }
      }
    }
    
    // Determinar ranking basado en puntos
    let ranking = 'Nuevo';
    if (puntos >= 100) ranking = 'L√≠der';
    else if (puntos >= 50) ranking = 'Destacado';
    else if (puntos >= 20) ranking = 'Activo';
    else if (puntos > 0) ranking = 'Participante';
    
    return {
      eventosAsistidos: eventos,
      horasVoluntariado: horas,
      proyectosParticipados: proyectos,
      puntosAcumulados: puntos,
      ranking: ranking
    };
    
  } catch (error) {
    console.error('Error obteniendo estad√≠sticas:', error);
    return {
      eventosAsistidos: 0,
      horasVoluntariado: 0,
      proyectosParticipados: 0,
      puntosAcumulados: 0,
      ranking: 'Nuevo'
    };
  }
}

function obtenerActividadesRecientes(usuarioId) {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const hojaActividades = spreadsheet.getSheetByName(CONFIG.sheetNames.actividades);
    
    if (!hojaActividades) {
      return [];
    }
    
    const datos = hojaActividades.getDataRange().getValues();
    const actividades = [];
    
    // Obtener m√°ximo 5 actividades recientes
    for (let filaIndex = 1; filaIndex < datos.length && actividades.length < 5; filaIndex++) {
      if (parseInt(datos[filaIndex][1]) === parseInt(usuarioId)) {
        actividades.push({
          id: datos[filaIndex][0],
          nombre: datos[filaIndex][2] || 'Actividad sin nombre',
          tipo: datos[filaIndex][3] || 'Evento',
          horas: datos[filaIndex][4] || 0,
          fecha: datos[filaIndex][5] || '',
          puntos: datos[filaIndex][6] || 0,
          descripcion: datos[filaIndex][7] || '',
          estado: datos[filaIndex][9] || 'Completada'
        });
      }
    }
    
    return actividades;
    
  } catch (error) {
    console.error('Error obteniendo actividades:', error);
    return [];
  }
}

function obtenerActividadesUsuario(usuarioId) {
  try {
    const actividades = obtenerActividadesRecientes(usuarioId);
    
    return {
      success: true,
      data: actividades
    };
    
  } catch (error) {
    console.error('Error obteniendo actividades:', error);
    return {
      success: false,
      error: 'Error al obtener actividades'
    };
  }
}

// ============================================
// 7. FUNCIONES DE UTILIDAD
// ============================================

function extraerNombreDesdeEmail(email) {
  if (!email) return 'Usuario GDB';
  
  try {
    // Obtener parte antes del @
    let nombre = email.split('@')[0];
    
    // Reemplazar caracteres especiales por espacios
    nombre = nombre.replace(/[._-]/g, ' ')
                   .replace(/\d+/g, '')
                   .trim();
    
    // Capitalizar palabras
    nombre = nombre.split(/\s+/)
      .filter(palabra => palabra.length > 0)
      .map(palabra => {
        if (palabra.length <= 2) return palabra.toLowerCase();
        return palabra.charAt(0).toUpperCase() + palabra.slice(1).toLowerCase();
      })
      .join(' ');
    
    return nombre || 'Usuario GDB';
    
  } catch (error) {
    return 'Usuario GDB';
  }
}

function obtenerIniciales(nombre) {
  if (!nombre) return 'G';
  
  const partes = nombre.split(' ');
  if (partes.length >= 2) {
    return (partes[0].charAt(0) + partes[1].charAt(0)).toUpperCase();
  }
  
  return nombre.charAt(0).toUpperCase();
}

function generarSaltAleatorio() {
  const caracteres = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
  let salt = '';
  
  for (let i = 0; i < 16; i++) {
    salt += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
  }
  
  return salt;
}

function generarHashContrasena(password, salt) {
  const combinado = salt + password;
  
  const hash = Utilities.computeDigest(
    Utilities.DigestAlgorithm.SHA_256,
    combinado,
    Utilities.Charset.UTF_8
  );
  
  // Convertir a hexadecimal
  return hash.map(byte => ('00' + (byte & 0xFF).toString(16)).slice(-2)).join('');
}

function generarTokenDeSesion(usuarioId) {
  const timestamp = Date.now();
  const aleatorio = Math.random().toString(36).substring(2, 15);
  const combinado = `${usuarioId}${timestamp}${aleatorio}`;
  
  return Utilities.base64Encode(combinado).substring(0, 50);
}

function esValorVerdadero(valor) {
  if (!valor) return false;
  
  const valorString = valor.toString().toLowerCase().trim();
  
  return valorString === 'true' ||
         valorString === '1' ||
         valorString === 'si' ||
         valorString === 'yes' ||
         valorString === 'verdadero';
}

function registrarLogSistema(idUsuario, email, accion, exitoso, detalles = '') {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    let hojaLogs = spreadsheet.getSheetByName(CONFIG.sheetNames.logs);
    
    // Crear hoja de logs si no existe
    if (!hojaLogs) {
      hojaLogs = spreadsheet.insertSheet(CONFIG.sheetNames.logs);
      
      // Crear encabezados
      const encabezados = ['Timestamp', 'ID_Usuario', 'Email', 'Accion', 'Exitoso', 'Detalles'];
      hojaLogs.appendRow(encabezados);
      
      // Formatear encabezados
      hojaLogs.getRange('A1:F1')
        .setFontWeight('bold')
        .setBackground('#2196F3')
        .setFontColor('white');
      
      console.log('‚úÖ Hoja de Logs creada');
    }
    
    // Preparar nueva fila de log
    const nuevaFilaLog = [
      new Date().toISOString(),
      idUsuario || 'N/A',
      email || 'N/A',
      accion,
      exitoso ? 'TRUE' : 'FALSE',
      detalles.substring(0, 400) // Limitar longitud
    ];
    
    // Agregar fila
    hojaLogs.appendRow(nuevaFilaLog);
    
    // Mantener m√°ximo 5000 registros
    if (hojaLogs.getLastRow() > 5000) {
      hojaLogs.deleteRow(2);
    }
    
    console.log(`üìù Log: ${accion} - ${exitoso ? '‚úÖ' : '‚ùå'}`);
    return true;
    
  } catch (error) {
    console.error('‚ùå Error registrando log:', error);
    return false;
  }
}

// ============================================
// 8. CREACI√ìN DE HOJAS COMPLEMENTARIAS
// ============================================

function crearHojaDetallesUsuariosCompleta() {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    let hojaDetalles = spreadsheet.getSheetByName(CONFIG.sheetNames.detalles);
    
    if (!hojaDetalles) {
      console.log('üìÅ Creando hoja DetallesUsuarios...');
      hojaDetalles = spreadsheet.insertSheet(CONFIG.sheetNames.detalles);
      
      // ENCABEZADOS COMPLETOS
      const encabezados = [
        'ID',                    // A
        'NombreCompleto',        // B
        'FechaNacimiento',       // C
        'Telefono',              // D
        'WhatsApp',              // E
        'Departamento',          // F
        'Ciudad',                // G
        'Institucion',           // H
        'Carrera',               // I
        'Semestre',              // J
        'Genero',                // K
        'Facebook',              // L
        'Instagram',             // M
        'Biografia',             // N
        'FotoURL',               // O
        'Intereses',             // P
        'Habilidades',           // Q
        'Idiomas',               // R
        'FechaRegistro',         // S
        'FechaActualizacion'     // T
      ];
      
      // Agregar encabezados
      hojaDetalles.appendRow(encabezados);
      
      // Formatear encabezados
      hojaDetalles.getRange('A1:T1')
        .setFontWeight('bold')
        .setBackground('#4CAF50')
        .setFontColor('white');
      
      // Congelar primera fila
      hojaDetalles.setFrozenRows(1);
      
      // Ajustar ancho de columnas
      hojaDetalles.autoResizeColumns(1, encabezados.length);
      
      console.log('‚úÖ Hoja DetallesUsuarios creada con estructura completa');
      
      // COPIAR USUARIOS EXISTENTES DESDE CREDENCIALES
      const hojaCredenciales = spreadsheet.getSheetByName(CONFIG.sheetNames.credenciales);
      
      if (hojaCredenciales && hojaCredenciales.getLastRow() > 1) {
        const usuarios = hojaCredenciales.getDataRange().getValues();
        let usuariosCopiados = 0;
        
        for (let filaIndex = 1; filaIndex < usuarios.length; filaIndex++) {
          const id = usuarios[filaIndex][COLUMNAS.CREDENCIALES.ID];
          const email = usuarios[filaIndex][COLUMNAS.CREDENCIALES.EMAIL];
          
          if (id && email) {
            const nombre = extraerNombreDesdeEmail(email);
            const fechaActual = new Date().toISOString();
            
            // Agregar fila con datos b√°sicos
            hojaDetalles.appendRow([
              id,                    // ID
              nombre,               // NombreCompleto
              '',                   // FechaNacimiento
              '',                   // Telefono
              '',                   // WhatsApp
              'Beni',               // Departamento
              'Trinidad',           // Ciudad
              'Generaci√≥n Diplom√°tica del Beni', // Instituci√≥n
              '',                   // Carrera
              '',                   // Semestre
              '',                   // G√©nero
              '',                   // Facebook
              '',                   // Instagram
              `Miembro de GDB Beni. Email: ${email}`, // Biograf√≠a
              '',                   // FotoURL
              'Diplomacia, Liderazgo, Voluntariado', // Intereses
              'Comunicaci√≥n, Trabajo en equipo', // Habilidades
              'Espa√±ol',            // Idiomas
              fechaActual,          // FechaRegistro
              fechaActual           // FechaActualizacion
            ]);
            
            usuariosCopiados++;
          }
        }
        
        console.log(`‚úÖ ${usuariosCopiados} usuarios copiados a DetallesUsuarios`);
      }
    }
    
    return {
      success: true,
      message: 'Hoja DetallesUsuarios lista'
    };
    
  } catch (error) {
    console.error('‚ùå Error creando hoja DetallesUsuarios:', error);
    return {
      success: false,
      error: error.toString()
    };
  }
}

function crearHojaActividadesGDB() {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    let hojaActividades = spreadsheet.getSheetByName(CONFIG.sheetNames.actividades);
    
    if (!hojaActividades) {
      console.log('üìÅ Creando hoja ActividadesGDB...');
      hojaActividades = spreadsheet.insertSheet(CONFIG.sheetNames.actividades);
      
      // ENCABEZADOS PARA ACTIVIDADES
      const encabezados = [
        'ID_Actividad',      // A
        'ID_Usuario',        // B
        'Nombre_Actividad',  // C
        'Tipo',              // D
        'Horas',             // E
        'Fecha',             // F
        'Puntos',            // G
        'Descripcion',       // H
        'Responsable',       // I
        'Estado',            // J
        'Evidencia_URL',     // K
        'Fecha_Registro'     // L
      ];
      
      // Agregar encabezados
      hojaActividades.appendRow(encabezados);
      
      // Formatear encabezados
      hojaActividades.getRange('A1:L1')
        .setFontWeight('bold')
        .setBackground('#FF9800')
        .setFontColor('white');
      
      // Congelar primera fila
      hojaActividades.setFrozenRows(1);
      
      // Ajustar ancho de columnas
      hojaActividades.autoResizeColumns(1, encabezados.length);
      
      console.log('‚úÖ Hoja ActividadesGDB creada');
    }
    
    return {
      success: true,
      message: 'Hoja ActividadesGDB lista'
    };
    
  } catch (error) {
    console.error('‚ùå Error creando hoja ActividadesGDB:', error);
    return {
      success: false,
      error: error.toString()
    };
  }
}

// ============================================
// 9. CREACI√ìN DE USUARIOS INICIALES (FUNCI√ìN DEL MEN√ö)
// ============================================

function crearUsuariosInicialesGDB() {
  console.log("üöÄ INICIANDO: Creaci√≥n de usuarios GDB Beni");
  
  try {
    const ui = SpreadsheetApp.getUi();
    
    // CONFIRMACI√ìN
    const respuesta = ui.alert(
      'üë• CREAR USUARIOS GDB BENI',
      '¬øCrear los 53 usuarios iniciales?\n\n' +
      'Se crear√°n con estos datos:\n' +
      '‚Ä¢ Email: Lista completa GDB\n' +
      '‚Ä¢ Contrase√±a: ID + "GDB" (ej: 0001GDB)\n' +
      '‚Ä¢ Tipo: Seg√∫n lista (admin/delegado)',
      ui.ButtonSet.YES_NO
    );
    
    if (respuesta !== ui.Button.YES) {
      console.log("‚ùå Cancelado por el usuario");
      return { success: false, message: "Operaci√≥n cancelada" };
    }
    
    // LISTA COMPLETA DE USUARIOS GDB
    const usuariosGDB = [
      [1, 'adr.cxsz@gmail.com', 'Adrian Su√°rez Su√°rez', 'admin'],
      [15, 'angeldavidvillavicenciolopez@gmail.com', 'Angel David Villavicencio L√≥pez', 'delegado'],
      [17, 'barriosbianca103@gmail.com', 'Bianca Paola Barrios', 'delegado'],
      [19, 'carry_vhg1605@icloud.com', 'Carla Lorena Herrera', 'delegado'],
      [22, 'hurtadoquevedof@gmail.com', 'Freddy Hurtado Quevedo', 'delegado'],
      [36, 'herreralucianac10@gmail.com', 'Luciana Emily Herrera', 'delegado'],
      [37, 'mariateresasotomayorrodriguez@gmail.com', 'Maria Teresa Sotomayor Rodr√≠guez', 'delegado'],
      [39, 'marytrujillo027@gmail.com', 'Mariel Trujillo', 'delegado'],
      [42, 'nuriaangelica01@gmail.com', 'Nuria Angelica Rojas', 'delegado'],
      [43, 'pedrojoelrp@gmail.com', 'Pedro Joel Rivas', 'delegado'],
      [46, 'puertachavezt@gmail.com', 'Thiago Puertas Ch√°vez', 'delegado'],
      [48, 'zammatorra@gmail.com', 'Zamara Matorra', 'delegado'],
      [44, '171208ssfl@gmail.com', 'Sara Sthepany Flores', 'delegado'],
      [33, 'kamilarubicallezambrana@gmail.com', 'Kamila Rubi Calles Zambrana', 'delegado'],
      [52, 'carlitosyverjustiniano@gmail.com', 'Carlos Yver Justiniano', 'admin'],
      [26, 'suarezjohnny0806@gmail.com', 'Johnny Suarez', 'delegado'],
      [27, 'Joseeliasmunoznajar@gmail.com', 'Jose Elias Mu√±oz Najar Saucedo', 'delegado'],
      [53, 'milenanube1@gmail.com', 'Milena Yusara Lopez', 'delegado'],
      [7, 'jorgegab1205@gmail.com', 'Jorge Gabriel Chavez', 'director'],
    ];
    
    let resultados = [];
    let nuevosCreados = 0;
    let yaExistentes = 0;
    let errores = 0;
    
    // PROCESAR CADA USUARIO
    usuariosGDB.forEach((usuario, index) => {
      const [idEspecifico, email, nombre, tipo] = usuario;
      
      try {
        console.log(`üîÑ Procesando ${index + 1}/${usuariosGDB.length}: ${email}`);
        
        // VERIFICAR SI YA EXISTE
        const existe = verificarSiUsuarioExiste(email);
        
        if (existe) {
          console.log(`   ‚ö†Ô∏è Ya existe: ${email}`);
          yaExistentes++;
          resultados.push({
            id: idEspecifico,
            email: email,
            nombre: nombre,
            estado: '‚ö†Ô∏è YA_EXISTE',
            mensaje: 'Usuario ya registrado'
          });
          return;
        }
        
        // CREAR CONTRASE√ëA TEMPORAL
        const passwordTemporal = idEspecifico.toString().padStart(4, '0') + 'GDB';
        
        // REGISTRAR NUEVO USUARIO
        const resultadoRegistro = registrarNuevoUsuario(email, passwordTemporal, tipo, idEspecifico);
        
        if (resultadoRegistro.success) {
          nuevosCreados++;
          resultados.push({
            id: idEspecifico,
            email: email,
            nombre: nombre,
            password: passwordTemporal,
            tipo: tipo,
            estado: '‚úÖ NUEVO_CREADO',
            mensaje: 'Usuario creado exitosamente'
          });
          console.log(`   ‚úÖ Creado: ${email} - ${passwordTemporal}`);
        } else {
          errores++;
          resultados.push({
            id: idEspecifico,
            email: email,
            nombre: nombre,
            estado: '‚ùå ERROR',
            mensaje: resultadoRegistro.error || 'Error desconocido'
          });
          console.log(`   ‚ùå Error: ${email} - ${resultadoRegistro.error}`);
        }
        
      } catch (error) {
        errores++;
        resultados.push({
          id: idEspecifico,
          email: email,
          nombre: nombre,
          estado: 'üí• EXCEPCI√ìN',
          mensaje: error.toString()
        });
        console.error(`   üí• Excepci√≥n con ${email}:`, error);
      }
    });
    
    // CREAR HOJAS COMPLEMENTARIAS
    crearHojaDetallesUsuariosCompleta();
    crearHojaActividadesGDB();
    
    // MOSTRAR RESULTADO
    const mensajeFinal = `
üìä PROCESO COMPLETADO

‚úÖ Nuevos usuarios creados: ${nuevosCreados}
‚ö†Ô∏è Usuarios ya existentes: ${yaExistentes}
‚ùå Errores encontrados: ${errores}
üìã Total procesados: ${usuariosGDB.length}

üîë Formato de contrase√±a: ID(4 d√≠gitos) + "GDB"
Ejemplo: ID 15 ‚Üí Contrase√±a: 0015GDB

üìç Las hojas "DetallesUsuarios" y "ActividadesGDB" han sido configuradas.
    `;
    
    ui.alert('üìä PROCESO COMPLETADO', mensajeFinal, ui.ButtonSet.OK);
    
    return {
      success: nuevosCreados > 0 || errores === 0,
      nuevosCreados: nuevosCreados,
      yaExistentes: yaExistentes,
      errores: errores,
      totalProcesados: usuariosGDB.length
    };
    
  } catch (error) {
    console.error('üí• ERROR CR√çTICO en crearUsuariosInicialesGDB:', error);
    SpreadsheetApp.getUi().alert('‚ùå ERROR CR√çTICO', error.toString(), SpreadsheetApp.getUi().ButtonSet.OK);
    return { success: false, error: error.toString() };
  }
}

function verificarSiUsuarioExiste(email) {
  try {
    if (!email) return false;
    
    const emailLimpio = email.trim().toLowerCase();
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const hojaCredenciales = spreadsheet.getSheetByName(CONFIG.sheetNames.credenciales);
    
    if (!hojaCredenciales) return false;
    
    const datos = hojaCredenciales.getDataRange().getValues();
    
    for (let filaIndex = 1; filaIndex < datos.length; filaIndex++) {
      const emailExistente = datos[filaIndex][COLUMNAS.CREDENCIALES.EMAIL];
      
      if (emailExistente &&
          emailExistente.toString().trim().toLowerCase() === emailLimpio) {
        return true;
      }
    }
    
    return false;
  } catch (error) {
    console.error('Error verificando usuario:', error);
    return false;
  }
}

function registrarNuevoUsuario(email, password, tipoUsuario = 'delegado', idEspecifico = null) {
  console.log(`üìù Registrando usuario: ${email}, Tipo: ${tipoUsuario}`);
  
  // VALIDACI√ìN
  if (!email || typeof email !== 'string') {
    return {
      success: false,
      error: 'El email es requerido y debe ser texto'
    };
  }
  
  const emailLimpio = email.trim().toLowerCase();
  
  if (emailLimpio === '' || emailLimpio === 'undefined') {
    return {
      success: false,
      error: 'El email no puede estar vac√≠o'
    };
  }
  
  if (!emailLimpio.includes('@') || !emailLimpio.includes('.')) {
    return {
      success: false,
      error: 'Formato de email no v√°lido'
    };
  }
  
  if (!password || password.length < 6) {
    return {
      success: false,
      error: 'La contrase√±a debe tener al menos 6 caracteres'
    };
  }
  
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const hojaCredenciales = spreadsheet.getSheetByName(CONFIG.sheetNames.credenciales);
    
    if (!hojaCredenciales) {
      return {
        success: false,
        error: 'No se encuentra la hoja "Credenciales"'
      };
    }
    
    // OBTENER DATOS EXISTENTES
    const datos = hojaCredenciales.getDataRange().getValues();
    
    // VERIFICAR SI EL EMAIL YA EXISTE
    for (let filaIndex = 1; filaIndex < datos.length; filaIndex++) {
      const emailExistente = datos[filaIndex][COLUMNAS.CREDENCIALES.EMAIL];
      
      if (emailExistente &&
          emailExistente.toString().trim().toLowerCase() === emailLimpio) {
        return {
          success: false,
          error: 'Este email ya est√° registrado'
        };
      }
    }
    
    // DETERMINAR NUEVO ID
    let nuevoId;
    
    if (idEspecifico !== null && idEspecifico !== undefined && !isNaN(parseInt(idEspecifico))) {
      const idEspecificoNum = parseInt(idEspecifico);
      
      // Verificar que el ID espec√≠fico no exista
      for (let filaIndex = 1; filaIndex < datos.length; filaIndex++) {
        if (parseInt(datos[filaIndex][COLUMNAS.CREDENCIALES.ID]) === idEspecificoNum) {
          return {
            success: false,
            error: `El ID ${idEspecifico} ya est√° en uso`
          };
        }
      }
      
      nuevoId = idEspecificoNum;
    } else {
      // ID auto-incremental
      let maxId = 0;
      for (let filaIndex = 1; filaIndex < datos.length; filaIndex++) {
        const idActual = parseInt(datos[filaIndex][COLUMNAS.CREDENCIALES.ID]) || 0;
        if (idActual > maxId) maxId = idActual;
      }
      nuevoId = maxId + 1;
    }
    
    // CORREGIR TIPO DE USUARIO
    const tipoCorregido = tipoUsuario.toLowerCase() === 'admin' ? 'admin' : 'delegado';
    
    // GENERAR HASH DE CONTRASE√ëA
    const salt = generarSaltAleatorio();
    const hashContrasena = generarHashContrasena(password, salt);
    const fechaActualISO = new Date().toISOString();
    
    // PREPARAR NUEVA FILA
    const nuevaFila = [
      nuevoId,                    // ID
      emailLimpio,               // Email
      hashContrasena,            // PasswordHash
      salt,                      // Salt
      tipoCorregido,             // TipoUsuario
      true,                      // Activo
      fechaActualISO,            // FechaCreacion
      null,                      // UltimoAcceso
      null                       // TokenRecuperacion
    ];
    
    // AGREGAR A LA HOJA
    hojaCredenciales.appendRow(nuevaFila);
    
    // REGISTRAR EN LOGS
    registrarLogSistema(nuevoId, emailLimpio, 'REGISTRO', true,
                       `Nuevo ${tipoCorregido} registrado - ID: ${nuevoId}`);
    
    return {
      success: true,
      message: 'Usuario registrado exitosamente',
      data: {
        id: nuevoId,
        email: emailLimpio,
        tipo: tipoCorregido,
        passwordTemporal: password
      }
    };
    
  } catch (error) {
    console.error('‚ùå Error en registrarNuevoUsuario:', error);
    registrarLogSistema(null, emailLimpio || 'N/A', 'REGISTRO_ERROR', false,
                       error.toString());
    
    return {
      success: false,
      error: 'Error en el servidor: ' + error.message
    };
  }
}
function completarCredencialesFaltantes() {
  console.log("üîß Completando credenciales faltantes...");
  
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const hojaCredenciales = spreadsheet.getSheetByName(CONFIG.sheetNames.credenciales);
    const ui = SpreadsheetApp.getUi();
    
    if (!hojaCredenciales) {
      ui.alert('‚ùå Error', 'No se encuentra la hoja "Credenciales"', ui.ButtonSet.OK);
      return;
    }
    
    const datos = hojaCredenciales.getDataRange().getValues();
    let actualizados = 0;
    let errores = 0;
    let resultados = [];
    
    for (let filaIndex = 1; filaIndex < datos.length; filaIndex++) {
      const filaNum = filaIndex + 1;
      const id = datos[filaIndex][COLUMNAS.CREDENCIALES.ID];
      const email = datos[filaIndex][COLUMNAS.CREDENCIALES.EMAIL];
      const hashActual = datos[filaIndex][COLUMNAS.CREDENCIALES.PASSWORD_HASH];
      const saltActual = datos[filaIndex][COLUMNAS.CREDENCIALES.SALT];
      const tipo = datos[filaIndex][COLUMNAS.CREDENCIALES.TIPO_USUARIO] || 'delegado';
      
      // Solo procesar si hay email pero falta hash o salt
      if (email && email.toString().trim() !== '' && (!hashActual || !saltActual || hashActual === '' || saltActual === '')) {
        try {
          console.log(`üìù Procesando ID ${id}: ${email}`);
          
          // Generar contrase√±a temporal (ID + "GDB")
          const passwordTemporal = id.toString().padStart(4, '0') + 'GDB';
          
          // Generar nuevo salt y hash
          const nuevoSalt = generarSaltAleatorio();
          const nuevoHash = generarHashContrasena(passwordTemporal, nuevoSalt);
          
          // Actualizar en la hoja
          hojaCredenciales.getRange(filaNum, COLUMNAS.CREDENCIALES.PASSWORD_HASH + 1)
                         .setValue(nuevoHash);
          hojaCredenciales.getRange(filaNum, COLUMNAS.CREDENCIALES.SALT + 1)
                         .setValue(nuevoSalt);
          
          // Asegurar que el tipo de usuario est√© correcto
          if (!tipo || tipo === '') {
            hojaCredenciales.getRange(filaNum, COLUMNAS.CREDENCIALES.TIPO_USUARIO + 1)
                           .setValue('delegado');
          }
          
          // Establecer como activo si no est√° definido
          const activoActual = datos[filaIndex][COLUMNAS.CREDENCIALES.ACTIVO];
          if (activoActual === '' || activoActual === undefined) {
            hojaCredenciales.getRange(filaNum, COLUMNAS.CREDENCIALES.ACTIVO + 1)
                           .setValue(true);
          }
          
          actualizados++;
          resultados.push({
            id: id,
            email: email,
            estado: '‚úÖ ACTUALIZADO',
            password: passwordTemporal,
            mensaje: `Credenciales creadas - Contrase√±a: ${passwordTemporal}`
          });
          
          console.log(`   ‚úÖ Credenciales creadas para ${email} - ${passwordTemporal}`);
          
        } catch (error) {
          errores++;
          resultados.push({
            id: id,
            email: email,
            estado: '‚ùå ERROR',
            mensaje: error.toString()
          });
          console.error(`   ‚ùå Error con ID ${id}:`, error);
        }
      }
    }
    
    // Actualizar fecha de creaci√≥n para los nuevos
    for (let filaIndex = 1; filaIndex < datos.length; filaIndex++) {
      const filaNum = filaIndex + 1;
      const fechaCreacion = datos[filaIndex][COLUMNAS.CREDENCIALES.FECHA_CREACION];
      
      if (!fechaCreacion || fechaCreacion === '') {
        hojaCredenciales.getRange(filaNum, COLUMNAS.CREDENCIALES.FECHA_CREACION + 1)
                       .setValue(new Date().toISOString());
      }
    }
    
    // Crear mensaje de resultado
    let mensajeResultado = `üìä PROCESO DE ACTUALIZACI√ìN COMPLETADO\n\n`;
    mensajeResultado += `‚úÖ Usuarios actualizados: ${actualizados}\n`;
    mensajeResultado += `‚ùå Errores: ${errores}\n`;
    mensajeResultado += `üìã Total procesados: ${datos.length - 1}\n\n`;
    
    mensajeResultado += `üîë Formato de contrase√±a: ID(4 d√≠gitos) + "GDB"\n`;
    mensajeResultado += `Ejemplo: ID 7 ‚Üí Contrase√±a: 0007GDB\n\n`;
    
    if (resultados.length > 0) {
      mensajeResultado += `üìã RESULTADOS DETALLADOS:\n`;
      mensajeResultado += `='.repeat(50)}\n`;
      
      resultados.forEach((resultado, index) => {
        if (index < 10) { // Mostrar solo los primeros 10
          mensajeResultado += `${resultado.estado} ID ${resultado.id}: ${resultado.email}\n`;
          if (resultado.password) {
            mensajeResultado += `   Contrase√±a: ${resultado.password}\n`;
          }
          if (index < 9) mensajeResultado += `\n`;
        }
      });
      
      if (resultados.length > 10) {
        mensajeResultado += `\n... y ${resultados.length - 10} m√°s`;
      }
    }
    
    ui.alert('üîß Actualizaci√≥n Completada', mensajeResultado, ui.ButtonSet.OK);
    
    return {
      success: true,
      actualizados: actualizados,
      errores: errores,
      total: datos.length - 1
    };
    
  } catch (error) {
    console.error('üí• ERROR CR√çTICO en completarCredencialesFaltantes:', error);
    SpreadsheetApp.getUi().alert('‚ùå ERROR CR√çTICO', error.toString(), SpreadsheetApp.getUi().ButtonSet.OK);
    return { success: false, error: error.toString() };
  }
}

function verificarEstadoCredenciales() {
  console.log("üîç Verificando estado de credenciales...");
  
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const hojaCredenciales = spreadsheet.getSheetByName(CONFIG.sheetNames.credenciales);
    const ui = SpreadsheetApp.getUi();
    
    if (!hojaCredenciales) {
      ui.alert('‚ùå Error', 'No se encuentra la hoja "Credenciales"', ui.ButtonSet.OK);
      return;
    }
    
    const datos = hojaCredenciales.getDataRange().getValues();
    let sinEmail = 0;
    let sinPassword = 0;
    let sinSalt = 0;
    let completos = 0;
    let problemas = [];
    
    for (let filaIndex = 1; filaIndex < datos.length; filaIndex++) {
      const id = datos[filaIndex][COLUMNAS.CREDENCIALES.ID];
      const email = datos[filaIndex][COLUMNAS.CREDENCIALES.EMAIL];
      const hash = datos[filaIndex][COLUMNAS.CREDENCIALES.PASSWORD_HASH];
      const salt = datos[filaIndex][COLUMNAS.CREDENCIALES.SALT];
      const tipo = datos[filaIndex][COLUMNAS.CREDENCIALES.TIPO_USUARIO];
      
      if (!email || email.toString().trim() === '') {
        sinEmail++;
      } else if (!hash || hash === '' || !salt || salt === '') {
        sinPassword++;
        problemas.push({
          id: id,
          email: email,
          problema: 'Falta PasswordHash o Salt',
          fila: filaIndex + 1
        });
      } else {
        completos++;
      }
    }
    
    let mensaje = `üîç DIAGN√ìSTICO DE CREDENCIALES\n\n`;
    mensaje += `üìä ESTAD√çSTICAS:\n`;
    mensaje += `‚úÖ Completos: ${completos}\n`;
    mensaje += `‚ùå Sin Password/Salt: ${sinPassword}\n`;
    mensaje += `üì≠ Sin Email: ${sinEmail}\n`;
    mensaje += `üìã Total registros: ${datos.length - 1}\n\n`;
    
    if (problemas.length > 0) {
      mensaje += `‚ö†Ô∏è USUARIOS CON PROBLEMAS:\n`;
      mensaje += `='.repeat(50)}\n`;
      
      problemas.forEach((problema, index) => {
        if (index < 15) { // Mostrar solo primeros 15
          mensaje += `${index + 1}. ID ${problema.id}: ${problema.email}\n`;
          mensaje += `   Fila: ${problema.fila} - ${problema.problema}\n`;
          if (index < 14) mensaje += `\n`;
        }
      });
      
      if (problemas.length > 15) {
        mensaje += `\n... y ${problemas.length - 15} m√°s`;
      }
      
      mensaje += `\n\nüí° RECOMENDACI√ìN: Ejecuta "Completar Credenciales Faltantes"`;
    } else {
      mensaje += `üéâ ¬°Todas las credenciales est√°n completas!`;
    }
    
    ui.alert('üîç Diagn√≥stico del Sistema', mensaje, ui.ButtonSet.OK);
    
    return {
      completos: completos,
      sinPassword: sinPassword,
      sinEmail: sinEmail,
      problemas: problemas
    };
    
  } catch (error) {
    console.error('Error en verificarEstadoCredenciales:', error);
    SpreadsheetApp.getUi().alert('‚ùå Error', error.toString(), SpreadsheetApp.getUi().ButtonSet.OK);
    return { error: error.toString() };
  }
}
// ============================================
// 10. FUNCIONES DEL MEN√ö
// ============================================

function onOpen() {
  try {
    const ui = SpreadsheetApp.getUi();
    
    // Crear men√∫ principal
    const menu = ui.createMenu('üöÄ GDB SISTEMA DEFINITIVO');
    
    // Agregar elementos del men√∫
    menu.addItem('üë• CREAR 15 USUARIOS GDB', 'crearUsuariosInicialesGDB')
        .addSeparator()
        .addItem('üîß Completar Credenciales Faltantes', 'completarCredencialesFaltantes')
        .addItem('üîç Verificar Estado Credenciales', 'verificarEstadoCredenciales')
        .addSeparator()
        .addItem('üìä Ver Estado del Sistema', 'mostrarEstadoSistema')
        .addItem('üë§ Ver Lista de Usuarios', 'mostrarListaUsuarios')
        .addItem('üîë Ver Contrase√±as', 'mostrarContrasenas')
        .addSeparator()
        .addItem('üìÅ Crear Hoja Detalles', 'crearHojaDetallesUsuariosCompleta')
        .addItem('üìÅ Crear Hoja Actividades', 'crearHojaActividadesGDB')
        .addSeparator()
        .addItem('üîó Obtener URL Web', 'mostrarUrlWeb')
        .addItem('üß™ Probar Sistema', 'probarSistema');
    
    // Agregar men√∫ a la interfaz
    menu.addToUi();
    
    console.log('‚úÖ Men√∫ GDB Sistema cargado correctamente');
    
    // Mostrar notificaci√≥n
    SpreadsheetApp.getActiveSpreadsheet().toast(
      'üöÄ Men√∫ GDB cargado. Usa "GDB SISTEMA DEFINITIVO"',
      '‚úÖ Sistema Listo',
      5
    );
    
  } catch (error) {
    console.error('‚ùå Error creando men√∫:', error);
  }
}

function mostrarEstadoSistema() {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const ui = SpreadsheetApp.getUi();
    
    let mensaje = 'üìä ESTADO DEL SISTEMA GDB\n\n';
    
    // Contar usuarios
    const hojaCredenciales = spreadsheet.getSheetByName(CONFIG.sheetNames.credenciales);
    let totalUsuarios = 0;
    
    if (hojaCredenciales) {
      totalUsuarios = hojaCredenciales.getLastRow() - 1;
      mensaje += `üë• Usuarios registrados: ${totalUsuarios}\n`;
    }
    
    // Verificar hojas
    const hojasRequeridas = ['Credenciales', 'Logs', 'DetallesUsuarios', 'ActividadesGDB'];
    hojasRequeridas.forEach(hoja => {
      const existe = spreadsheet.getSheetByName(hoja);
      mensaje += `${existe ? '‚úÖ' : '‚ùå'} ${hoja}\n`;
    });
    
    // URL del servicio
    mensaje += `\nüîó URL del servicio: ${ScriptApp.getService().getUrl()}`;
    mensaje += `\nüìÖ √öltima verificaci√≥n: ${new Date().toLocaleString('es-ES')}`;
    
    ui.alert('üìä Estado del Sistema', mensaje, ui.ButtonSet.OK);
    
  } catch (error) {
    console.error('Error mostrando estado:', error);
    SpreadsheetApp.getUi().alert('‚ùå Error', error.toString(), SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

function mostrarListaUsuarios() {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const hojaCredenciales = spreadsheet.getSheetByName(CONFIG.sheetNames.credenciales);
    const ui = SpreadsheetApp.getUi();
    
    if (!hojaCredenciales || hojaCredenciales.getLastRow() <= 1) {
      ui.alert('üë§ Usuarios', 'No hay usuarios registrados en el sistema', ui.ButtonSet.OK);
      return;
    }
    
    const datos = hojaCredenciales.getDataRange().getValues();
    let mensaje = `üë• USUARIOS REGISTRADOS (${datos.length - 1}):\n\n`;
    
    // Mostrar primeros 10 usuarios
    const limiteMostrar = Math.min(10, datos.length - 1);
    
    for (let i = 1; i <= limiteMostrar; i++) {
      const usuario = datos[i];
      const estado = esValorVerdadero(usuario[COLUMNAS.CREDENCIALES.ACTIVO]) ? '‚úÖ' : '‚ùå';
      
      mensaje += `${i}. ${estado} ID ${usuario[COLUMNAS.CREDENCIALES.ID]}\n`;
      mensaje += `   üìß ${usuario[COLUMNAS.CREDENCIALES.EMAIL]}\n`;
      mensaje += `   üè∑Ô∏è  ${usuario[COLUMNAS.CREDENCIALES.TIPO_USUARIO]}\n`;
      
      if (i < limiteMostrar) {
        mensaje += `   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
      }
    }
    
    if (datos.length - 1 > limiteMostrar) {
      mensaje += `\n... y ${datos.length - 1 - limiteMostrar} usuarios m√°s`;
    }
    
    ui.alert('üë• Lista de Usuarios', mensaje, ui.ButtonSet.OK);
    
  } catch (error) {
    console.error('Error mostrando usuarios:', error);
    SpreadsheetApp.getUi().alert('‚ùå Error', error.toString(), SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

function mostrarContrasenas() {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const hojaCredenciales = spreadsheet.getSheetByName(CONFIG.sheetNames.credenciales);
    const ui = SpreadsheetApp.getUi();
    
    if (!hojaCredenciales || hojaCredenciales.getLastRow() <= 1) {
      ui.alert('üîë Contrase√±as', 'No hay usuarios registrados', ui.ButtonSet.OK);
      return;
    }
    
    const datos = hojaCredenciales.getDataRange().getValues();
    let mensaje = 'üîë CONTRASE√ëAS TEMPORALES GDB\n\n';
    mensaje += 'Formato: ID(4 d√≠gitos) + "GDB"\n';
    mensaje += 'Ejemplo: ID 15 ‚Üí Contrase√±a: 0015GDB\n\n';
    mensaje += '='.repeat(50) + '\n\n';
    
    // Mostrar contrase√±as de primeros 10 usuarios
    const limite = Math.min(10, datos.length - 1);
    
    for (let i = 1; i <= limite; i++) {
      const usuario = datos[i];
      const id = usuario[COLUMNAS.CREDENCIALES.ID];
      const email = usuario[COLUMNAS.CREDENCIALES.EMAIL];
      
      if (!id || !email) continue;
      
      const contrase√±a = id.toString().padStart(4, '0') + 'GDB';
      const nombre = extraerNombreDesdeEmail(email);
      
      mensaje += `${i}. ${nombre}\n`;
      mensaje += `   ID: ${id}\n`;
      mensaje += `   Email: ${email}\n`;
      mensaje += `   üîë ${contrase√±a}\n`;
      
      if (i < limite) {
        mensaje += `   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
      }
    }
    
    if (datos.length - 1 > limite) {
      mensaje += `\n... y ${datos.length - 1 - limite} usuarios m√°s`;
    }
    
    ui.alert('üîë Contrase√±as del Sistema', mensaje, ui.ButtonSet.OK);
    
  } catch (error) {
    console.error('Error mostrando contrase√±as:', error);
    SpreadsheetApp.getUi().alert('‚ùå Error', error.toString(), SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

function mostrarUrlWeb() {
  const url = ScriptApp.getService().getUrl();
  const ui = SpreadsheetApp.getUi();
  
  ui.alert(
    'üîó URL del Sistema Web',
    'Copia esta URL para configurar tu sitio web:\n\n' +
    url + '\n\n' +
    'Debes usar esta URL en:\n' +
    '‚Ä¢ login.html\n' +
    '‚Ä¢ perfil-privado.html\n\n' +
    'Ejemplo de c√≥digo:\n' +
    'const APPS_SCRIPT_URL = "' + url + '";',
    ui.ButtonSet.OK
  );
}

function probarSistema() {
  const ui = SpreadsheetApp.getUi();
  
  ui.alert(
    'üß™ Probar Sistema',
    'Para probar el sistema:\n\n' +
    '1. Usa el usuario admin:\n' +
    '   üìß adr.cxsz@gmail.com\n' +
    '   üîë 0001GDB\n\n' +
    '2. O cualquier usuario:\n' +
    '   üìß [cualquier email de la lista]\n' +
    '   üîë ID(4 d√≠gitos) + "GDB"\n\n' +
    '3. URL de prueba:\n' +
    ScriptApp.getService().getUrl() + '?action=status\n\n' +
    '4. Ejemplo de login:\n' +
    ScriptApp.getService().getUrl() + '?action=login&email=adr.cxsz@gmail.com&password=0001GDB',
    ui.ButtonSet.OK
  );
}

// ============================================
// 11. INICIALIZACI√ìN
// ============================================

function onInstall() {
  onOpen();
  console.log('‚úÖ GDB Sistema Definitivo instalado');
  
  // Mostrar mensaje de bienvenida
  SpreadsheetApp.getActiveSpreadsheet().toast(
    'üöÄ GDB Sistema Definitivo instalado. Usa el men√∫ "GDB SISTEMA DEFINITIVO"',
    '‚úÖ Instalaci√≥n Exitosa',
    10
  );
}

// ============================================
// 12. FUNCI√ìN DE PRUEBA R√ÅPIDA
// ============================================

function pruebaRapida() {
  console.log('üß™ Ejecutando prueba r√°pida...');
  
  // Probar login
  const resultado = autenticarUsuario('adr.cxsz@gmail.com', '0001GDB');
  console.log('Resultado login:', resultado);
  
  // Probar obtener perfil
  if (resultado.success) {
    const perfil = obtenerPerfilCompleto(resultado.data.id, resultado.data.sessionToken);
    console.log('Resultado perfil:', perfil.success ? '‚úÖ' : '‚ùå');
  }
  
  // Mostrar estado
  const estado = ScriptApp.getService().getUrl() + '?action=status';
  console.log('URL de estado:', estado);
  
  SpreadsheetApp.getActiveSpreadsheet().toast(
    '‚úÖ Prueba completada. Revisa la consola.',
    'üß™ Prueba R√°pida',
    5
  );
}
// ============================================
// 13. FUNCI√ìN DOPOST PARA ACTUALIZACIONES
// ============================================

function doPost(e) {
  console.log('üì® POST recibido:', JSON.stringify(e));
  
  const params = e.postData ? JSON.parse(e.postData.contents) : e.parameter || {};
  const action = params.action;
  
  let respuesta;
  
  try {
    switch(action) {
      case 'changePassword':
        respuesta = cambiarContrase√±aUsuarioWeb(
          params.userId,
          params.currentPassword,
          params.newPassword,
          params.sessionToken
        );
        break;
        
      case 'updateProfile':
        respuesta = actualizarPerfilUsuario(
          params.userId,
          params,
          params.sessionToken
        );
        break;
        
      case 'getAllMembers':
        respuesta = obtenerTodosLosMiembros();
        break;
        
      case 'getMemberById':
        respuesta = obtenerMiembroPorId(params.id);
        break;
        
      case 'updateMember':
        respuesta = actualizarMiembroPerfil(params);
        break;
        
      default:
        respuesta = {
          success: false,
          error: 'Acci√≥n no v√°lida'
        };
    }
  } catch(error) {
    respuesta = {
      success: false,
      error: error.message
    };
  }
  
  const output = ContentService.createTextOutput(JSON.stringify(respuesta));
  output.setMimeType(ContentService.MimeType.JSON);
  output.setHeaders({
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type'
  });
  
  return output;
}

// ============================================
// 14. FUNCIONES PARA EL DIRECTORIO
// ============================================

function obtenerTodosLosMiembros() {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const hojaDetalles = spreadsheet.getSheetByName(CONFIG.sheetNames.detalles);
    
    if (!hojaDetalles || hojaDetalles.getLastRow() <= 1) {
      return {
        success: true,
        data: []
      };
    }
    
    const datos = hojaDetalles.getDataRange().getValues();
    const miembros = [];
    
    for (let filaIndex = 1; filaIndex < datos.length; filaIndex++) {
      const fila = datos[filaIndex];
      
      // Obtener datos de credenciales para el tipo
      const id = parseInt(fila[0]);
      const tipo = obtenerTipoUsuarioPorId(id);
      
      miembros.push({
        id: id,
        nombre: fila[1] || 'Nombre no disponible',
        cargo: obtenerCargoPorTipo(tipo),
        tipo: tipo,
        comision: fila[7] || 'Sin comisi√≥n',
        universidad: fila[8] || '',
        semestre: fila[9] || '',
        municipio: fila[6] || 'Trinidad',
        telefono: fila[3] || '#######',
        nacimiento: fila[2] || '',
        biografia: fila[13] || 'Miembro de GDB Beni',
        intereses: fila[15] || 'Diplomacia, Liderazgo',
        avatar: fila[14] || '',
        colegio: fila[8] || '', // Usamos el campo carrera para colegio
        // Estad√≠sticas dummy
        eventos: Math.floor(Math.random() * 20),
        intervenciones: Math.floor(Math.random() * 15),
        talleres: Math.floor(Math.random() * 10),
        proyectos: Math.floor(Math.random() * 5)
      });
    }
    
    return {
      success: true,
      data: miembros
    };
    
  } catch (error) {
    console.error('‚ùå Error obteniendo miembros:', error);
    return {
      success: false,
      error: error.message
    };
  }
}

function obtenerTipoUsuarioPorId(idUsuario) {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const hojaCredenciales = spreadsheet.getSheetByName(CONFIG.sheetNames.credenciales);
    
    if (!hojaCredenciales) return 'delegado';
    
    const datos = hojaCredenciales.getDataRange().getValues();
    
    for (let filaIndex = 1; filaIndex < datos.length; filaIndex++) {
      if (parseInt(datos[filaIndex][COLUMNAS.CREDENCIALES.ID]) === idUsuario) {
        return datos[filaIndex][COLUMNAS.CREDENCIALES.TIPO_USUARIO] || 'delegado';
      }
    }
    
    return 'delegado';
  } catch (error) {
    console.error('Error obteniendo tipo de usuario:', error);
    return 'delegado';
  }
}

function obtenerCargoPorTipo(tipo) {
  switch(tipo) {
    case 'admin':
      return 'Administrador';
    case 'directivo':
      return 'Miembro Directivo';
    default:
      return 'Delegado';
  }
}

function obtenerMiembroPorId(id) {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const hojaDetalles = spreadsheet.getSheetByName(CONFIG.sheetNames.detalles);
    
    if (!hojaDetalles || hojaDetalles.getLastRow() <= 1) {
      return {
        success: false,
        error: 'No hay miembros registrados'
      };
    }
    
    const datos = hojaDetalles.getDataRange().getValues();
    
    for (let filaIndex = 1; filaIndex < datos.length; filaIndex++) {
      const fila = datos[filaIndex];
      
      if (parseInt(fila[0]) === parseInt(id)) {
        const tipo = obtenerTipoUsuarioPorId(id);
        
        const miembro = {
          id: id,
          nombre: fila[1] || 'Nombre no disponible',
          cargo: obtenerCargoPorTipo(tipo),
          tipo: tipo,
          comision: fila[7] || 'Sin comisi√≥n',
          universidad: fila[8] || '',
          semestre: fila[9] || '',
          municipio: fila[6] || 'Trinidad',
          telefono: fila[3] || '#######',
          nacimiento: fila[2] || '',
          biografia: fila[13] || 'Miembro de GDB Beni',
          intereses: fila[15] || 'Diplomacia, Liderazgo',
          avatar: fila[14] || '',
          colegio: fila[8] || '',
          // Estad√≠sticas dummy
          eventos: Math.floor(Math.random() * 20),
          intervenciones: Math.floor(Math.random() * 15),
          talleres: Math.floor(Math.random() * 10),
          proyectos: Math.floor(Math.random() * 5)
        };
        
        return {
          success: true,
          data: miembro
        };
      }
    }
    
    return {
      success: false,
      error: 'Miembro no encontrado'
    };
    
  } catch (error) {
    console.error('‚ùå Error obteniendo miembro:', error);
    return {
      success: false,
      error: error.message
    };
  }
}

function actualizarMiembroPerfil(params) {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const hojaDetalles = spreadsheet.getSheetByName(CONFIG.sheetNames.detalles);
    
    if (!hojaDetalles) {
      return {
        success: false,
        error: 'Hoja de detalles no encontrada'
      };
    }
    
    const datos = hojaDetalles.getDataRange().getValues();
    let filaIndex = -1;
    
    // Buscar miembro por ID
    for (let i = 1; i < datos.length; i++) {
      if (parseInt(datos[i][0]) === parseInt(params.id)) {
        filaIndex = i;
        break;
      }
    }
    
    if (filaIndex === -1) {
      return {
        success: false,
        error: 'Miembro no encontrado'
      };
    }
    
    const filaNum = filaIndex + 1;
    
    // Actualizar cada campo si est√° presente
    if (params.nombre !== undefined) {
      hojaDetalles.getRange(filaNum, 2).setValue(params.nombre);
    }
    if (params.nacimiento !== undefined) {
      hojaDetalles.getRange(filaNum, 3).setValue(params.nacimiento);
    }
    if (params.telefono !== undefined) {
      hojaDetalles.getRange(filaNum, 4).setValue(params.telefono);
    }
    if (params.whatsapp !== undefined) {
      hojaDetalles.getRange(filaNum, 5).setValue(params.whatsapp);
    }
    if (params.departamento !== undefined) {
      hojaDetalles.getRange(filaNum, 6).setValue(params.departamento);
    }
    if (params.municipio !== undefined) {
      hojaDetalles.getRange(filaNum, 7).setValue(params.municipio);
    }
    if (params.institucion !== undefined) {
      hojaDetalles.getRange(filaNum, 8).setValue(params.institucion);
    }
    if (params.carrera !== undefined) {
      hojaDetalles.getRange(filaNum, 9).setValue(params.carrera);
    }
    if (params.semestre !== undefined) {
      hojaDetalles.getRange(filaNum, 10).setValue(params.semestre);
    }
    if (params.genero !== undefined) {
      hojaDetalles.getRange(filaNum, 11).setValue(params.genero);
    }
    if (params.facebook !== undefined) {
      hojaDetalles.getRange(filaNum, 12).setValue(params.facebook);
    }
    if (params.instagram !== undefined) {
      hojaDetalles.getRange(filaNum, 13).setValue(params.instagram);
    }
    if (params.biografia !== undefined) {
      hojaDetalles.getRange(filaNum, 14).setValue(params.biografia);
    }
    if (params.fotoURL !== undefined) {
      hojaDetalles.getRange(filaNum, 15).setValue(params.fotoURL);
    }
    if (params.intereses !== undefined) {
      hojaDetalles.getRange(filaNum, 16).setValue(params.intereses);
    }
    if (params.habilidades !== undefined) {
      hojaDetalles.getRange(filaNum, 17).setValue(params.habilidades);
    }
    if (params.idiomas !== undefined) {
      hojaDetalles.getRange(filaNum, 18).setValue(params.idiomas);
    }
    
    // Actualizar fecha de modificaci√≥n
    hojaDetalles.getRange(filaNum, 20).setValue(new Date().toISOString());
    
    // Si se cambi√≥ el tipo, actualizar en credenciales
    if (params.tipo !== undefined) {
      const hojaCredenciales = spreadsheet.getSheetByName(CONFIG.sheetNames.credenciales);
      if (hojaCredenciales) {
        const datosCred = hojaCredenciales.getDataRange().getValues();
        
        for (let i = 1; i < datosCred.length; i++) {
          if (parseInt(datosCred[i][COLUMNAS.CREDENCIALES.ID]) === parseInt(params.id)) {
            hojaCredenciales.getRange(i + 1, COLUMNAS.CREDENCIALES.TIPO_USUARIO + 1)
                           .setValue(params.tipo);
            break;
          }
        }
      }
    }
    
    return {
      success: true,
      message: 'Perfil actualizado correctamente'
    };
    
  } catch (error) {
    console.error('‚ùå Error actualizando perfil:', error);
    return {
      success: false,
      error: error.message
    };
  }
}
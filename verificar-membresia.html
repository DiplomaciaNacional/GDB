<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificar Mi Membresía - GDB</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        .verificar-page {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.03) 0%, rgba(0, 100, 0, 0.03) 100%);
        }

        .verificar-header {
            background-color: #006400; /* dark-green */
            color: white;
            padding: 20px 5%;
            text-align: center;
        }

        .verificar-header h1 {
            color: white;
            margin-bottom: 10px;
        }

        .verificar-header p {
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }

        .verificar-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px 5%;
        }

        .verificar-card {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            padding: 40px;
            width: 100%;
            max-width: 600px;
        }

        .verificar-form .form-group {
            margin-bottom: 25px;
        }

        .verificar-form label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333; /* dark-gray */
        }

        .verificar-form input {
            width: 100%;
            padding: 14px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .verificar-form input:focus {
            outline: none;
            border-color: #8B0000; /* burgundy */
            box-shadow: 0 0 0 2px rgba(139, 0, 0, 0.1);
        }

        .verificar-btn {
            background-color: #006400; /* dark-green */
            color: white;
            border: none;
            padding: 16px 30px;
            border-radius: 5px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .verificar-btn:hover {
            background-color: #004d00;
        }

        .verificar-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .verificar-btn .fa-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .resultado-container {
            display: none;
            margin-top: 30px;
            padding: 25px;
            border-radius: 10px;
            background-color: #f8f9fa;
        }

        .resultado-al-dia {
            border-left: 5px solid #2e7d32;
        }

        .resultado-deudor {
            border-left: 5px solid #d32f2f;
        }

        .resultado-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .resultado-icon {
            font-size: 2.5rem;
        }

        .al-dia-icon {
            color: #2e7d32;
        }

        .deudor-icon {
            color: #d32f2f;
        }

        .resultado-info h3 {
            margin-bottom: 5px;
        }

        .resultado-info p {
            margin-bottom: 0;
            color: #666; /* medium-gray */
        }

        .resultado-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .detail-item {
            padding: 15px;
            background-color: white;
            border-radius: 5px;
            border: 1px solid #eee;
        }

        .detail-label {
            font-size: 0.9rem;
            color: #666; /* medium-gray */
            margin-bottom: 5px;
        }

        .detail-value {
            font-weight: 600;
            color: #333; /* dark-gray */
        }

        .verificar-actions {
            margin-top: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .action-link {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px;
            border-radius: 5px;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .action-link.pagar {
            background-color: #8B0000; /* burgundy */
            color: white;
        }

        .action-link.pagar:hover {
            background-color: #6a0000;
        }

        .action-link.contacto {
            background-color: rgba(139, 0, 0, 0.1);
            color: #8B0000; /* burgundy */
        }

        .action-link.contacto:hover {
            background-color: rgba(139, 0, 0, 0.2);
        }

        .back-link {
            display: inline-block;
            margin-top: 20px;
            color: #8B0000; /* burgundy */
            text-decoration: none;
            font-weight: 500;
        }

        .renewal-notice {
            background-color: #e3f2fd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }

        .renewal-notice i {
            color: #2196f3;
            margin-right: 10px;
        }

        .tipo-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .tipo-directiva {
            background-color: rgba(0, 100, 0, 0.1);
            color: #006400; /* dark-green */
        }

        .tipo-delegado {
            background-color: rgba(212, 175, 55, 0.1);
            color: #b08d00;
        }

        .autocomplete-suggestions {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: calc(100% - 30px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .autocomplete-suggestion {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .autocomplete-suggestion:hover {
            background-color: #f5f5f5;
        }

        .autocomplete-suggestion:last-child {
            border-bottom: none;
        }

        @media (max-width: 576px) {
            .verificar-card {
                padding: 30px 20px;
            }

            .resultado-header {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }

            .resultado-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="verificar-page">
        <div class="verificar-header">
            <h1>Verificar Estado de Membresía</h1>
            <p>Consulta el estado de tu membresía en la Generación Diplomática del Beni</p>
        </div>

        <div class="verificar-container">
            <div class="verificar-card">
                <div class="renewal-notice">
                    <i class="fas fa-info-circle"></i>
                    <strong>Recordatorio:</strong> La membresía se renueva automáticamente cada 14 de mes.
                    Pasada esta fecha sin pago, el estado cambia a "Deudor".
                </div>

                <form id="verificarForm" class="verificar-form">
                    <div class="form-group">
                        <label for="nombreVerificar">Nombre Completo</label>
                        <input type="text" id="nombreVerificar" name="nombreVerificar"
                            placeholder="Comienza a escribir tu nombre..." autocomplete="off" required>
                        <div id="autocompleteSuggestions" class="autocomplete-suggestions" style="display: none;"></div>
                    </div>

                    <button type="submit" class="verificar-btn" id="verificarBtn">
                        <span id="verificarText">Verificar Mi Estado</span>
                        <span id="verificarLoading" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i> Buscando...
                        </span>
                    </button>
                </form>

                <div id="resultadoContainer" class="resultado-container">
                    <!-- Resultado se mostrará aquí -->
                </div>

                <div class="verificar-actions" id="verificarActions" style="display: none;">
                    <a href="enviar-comprobante.html" class="action-link pagar">
                        <i class="fas fa-qrcode"></i> Pagar Membresía con QR
                    </a>
                    <a href="https://wa.me/59163177639" target="_blank" class="action-link contacto">
                        <i class="fas fa-envelope"></i> Contactar al Secretario de Finanzas
                    </a>
                </div>

                <a href="login-membresias.html" class="back-link">
                    <i class="fas fa-arrow-left"></i> Volver al inicio
                </a>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURACIÓN (igual que admin-membresias)
        // ============================================
        const CONFIG = {
            // Misma URL de Google Apps Script
            API_URL: 'https://script.google.com/macros/s/AKfycbyQiUgUTfdHNIENqVmwQx9jf0qzpYdQ4BxELdH3Hk9SIUT4HDYnGZEH9NRxNGs6h1TL/exec',
            // Modo desarrollo (true = usar solo localStorage, false = usar API real)
            MODO_DESARROLLO: false
        };

        // ============================================
        // FUNCIONES COMPARTIDAS CON ADMIN-MEMBRESIAS
        // ============================================

        // Función para verificar estado por fecha (misma lógica que admin)
        function verificarEstadoPorFecha(ultimaActualizacion) {
            const hoy = new Date();
            const fechaActualizacion = new Date(ultimaActualizacion);
            const diaDelMes = hoy.getDate();

            if (diaDelMes >= 14) {
                const mesActual = hoy.getMonth();
                const añoActual = hoy.getFullYear();
                const fechaLimite = new Date(añoActual, mesActual, 14);
                if (fechaActualizacion < fechaLimite) {
                    return 'deudor';
                }
            }

            const mesPasado = new Date();
            mesPasado.setMonth(mesPasado.getMonth() - 1);
            if (fechaActualizacion.getMonth() < mesPasado.getMonth() ||
                fechaActualizacion.getFullYear() < mesPasado.getFullYear()) {
                return 'deudor';
            }

            return 'al-dia';
        }

        // Función para obtener datos de membresías
        async function obtenerMiembros() {
            try {
                // Primero intentar cargar desde localStorage (datos más recientes)
                const datosLocales = localStorage.getItem('miembrosGDB');
                if (datosLocales) {
                    console.log('Cargando datos desde localStorage');
                    return JSON.parse(datosLocales);
                }

                // Si no hay datos locales, intentar con la API
                if (!CONFIG.MODO_DESARROLLO) {
                    console.log('Intentando cargar desde API...');
                    // NOTA: Este endpoint debe estar implementado en tu Google Apps Script
                    // const response = await fetch(`${CONFIG.API_URL}?action=obtenerTodos`);
                    // const data = await response.json();
                    // if (data.success && data.miembros) {
                    //     return data.miembros;
                    // }
                }

                // Si todo falla, usar datos de respaldo mínimos
                console.log('Usando datos de respaldo mínimos');
                return obtenerDatosMinimosRespaldo();
                
            } catch (error) {
                console.error('Error al obtener miembros:', error);
                return obtenerDatosMinimosRespaldo();
            }
        }

        // Datos mínimos de respaldo (para mostrar ejemplos)
        function obtenerDatosMinimosRespaldo() {
            return [
                { id: 1, nombre: "ADRIAN SUAREZ SUAREZ", cargo: "Presidente Departamental", departamento: "Beni", estado: "al-dia", ultimaActualizacion: "2025-01-20", tipo: "directiva" },
                { id: 2, nombre: "ARIANA QUIROZ ORTIZ", cargo: "Vicepresidente Departamental", departamento: "Beni", estado: "al-dia", ultimaActualizacion: "2025-01-15", tipo: "directiva" },
                { id: 15, nombre: "ANGEL PADILLA TEREBA", cargo: "Debate y Representación", telefono: "67351540", estado: "deudor", ultimaActualizacion: "2024-12-01", tipo: "delegado" },
                { id: 16, nombre: "AVRIL FABIANA LUIZAGA MARTINEZ", cargo: "Debate y Representación", telefono: "63276492", estado: "al-dia", ultimaActualizacion: "2025-01-15", tipo: "delegado" },
                { id: 17, nombre: "BIANCA PAOLA BARRIOS PERALTA", cargo: "Marketing", telefono: "73948684", estado: "al-dia", ultimaActualizacion: "2025-01-10", tipo: "delegado" }
            ];
        }

        // Función para buscar miembro (con coincidencias parciales)
        function buscarMiembro(nombre, miembros) {
            const nombreUpper = nombre.trim().toUpperCase();
            
            // Si está vacío
            if (!nombreUpper) return null;
            
            // Buscar coincidencia exacta primero
            let miembro = miembros.find(m => 
                m.nombre.toUpperCase() === nombreUpper
            );
            
            // Si no hay coincidencia exacta, buscar coincidencia parcial
            if (!miembro) {
                miembro = miembros.find(m => 
                    m.nombre.toUpperCase().includes(nombreUpper) ||
                    nombreUpper.includes(m.nombre.toUpperCase())
                );
            }
            
            return miembro;
        }

        // Función para mostrar sugerencias de autocompletado
        function mostrarSugerencias(input, miembros) {
            const valor = input.value.trim().toUpperCase();
            const sugerenciasDiv = document.getElementById('autocompleteSuggestions');
            
            if (valor.length < 2) {
                sugerenciasDiv.style.display = 'none';
                return;
            }
            
            const sugerencias = miembros.filter(m => 
                m.nombre.toUpperCase().includes(valor)
            ).slice(0, 5); // Limitar a 5 sugerencias
            
            if (sugerencias.length === 0) {
                sugerenciasDiv.style.display = 'none';
                return;
            }
            
            sugerenciasDiv.innerHTML = sugerencias.map(m => 
                `<div class="autocomplete-suggestion" data-nombre="${m.nombre}">${m.nombre}</div>`
            ).join('');
            sugerenciasDiv.style.display = 'block';
        }

        // ============================================
        // EVENT LISTENERS AL CARGAR LA PÁGINA
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            let miembrosGDB = [];
            
            // Cargar datos al iniciar
            try {
                miembrosGDB = await obtenerMiembros();
                console.log(`Cargados ${miembrosGDB.length} miembros`);
            } catch (error) {
                console.error('Error inicial al cargar miembros:', error);
                miembrosGDB = obtenerDatosMinimosRespaldo();
            }
            
            // Configurar autocompletado
            const nombreInput = document.getElementById('nombreVerificar');
            const sugerenciasDiv = document.getElementById('autocompleteSuggestions');
            
            nombreInput.addEventListener('input', function() {
                if (miembrosGDB.length > 0) {
                    mostrarSugerencias(this, miembrosGDB);
                }
            });
            
            // Seleccionar sugerencia
            sugerenciasDiv.addEventListener('click', function(e) {
                if (e.target.classList.contains('autocomplete-suggestion')) {
                    nombreInput.value = e.target.getAttribute('data-nombre');
                    sugerenciasDiv.style.display = 'none';
                }
            });
            
            // Cerrar sugerencias al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (!nombreInput.contains(e.target) && !sugerenciasDiv.contains(e.target)) {
                    sugerenciasDiv.style.display = 'none';
                }
            });
            
            // Manejar envío del formulario
            document.getElementById('verificarForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const nombre = nombreInput.value.trim();
                const resultadoContainer = document.getElementById('resultadoContainer');
                const verificarActions = document.getElementById('verificarActions');
                const verificarBtn = document.getElementById('verificarBtn');
                const verificarText = document.getElementById('verificarText');
                const verificarLoading = document.getElementById('verificarLoading');
                
                if (!nombre) {
                    alert('Por favor ingresa tu nombre');
                    return;
                }
                
                // Mostrar loading
                verificarText.style.display = 'none';
                verificarLoading.style.display = 'inline';
                verificarBtn.disabled = true;
                
                // Ocultar sugerencias
                sugerenciasDiv.style.display = 'none';
                
                // Intentar cargar datos frescos (por si hay actualizaciones)
                try {
                    const miembrosActualizados = await obtenerMiembros();
                    if (miembrosActualizados.length > 0) {
                        miembrosGDB = miembrosActualizados;
                    }
                } catch (error) {
                    console.warn('No se pudieron actualizar los datos:', error);
                }
                
                // Buscar miembro
                const miembro = buscarMiembro(nombre, miembrosGDB);
                
                // Restaurar botón
                verificarText.style.display = 'inline';
                verificarLoading.style.display = 'none';
                verificarBtn.disabled = false;
                
                if (!miembro) {
                    resultadoContainer.innerHTML = `
                        <div style="text-align: center; padding: 30px;">
                            <i class="fas fa-user-slash" style="font-size: 3rem; color: #ccc; margin-bottom: 15px;"></i>
                            <h3>Miembro no encontrado</h3>
                            <p>No se encontró un miembro con el nombre: <strong>${nombre}</strong></p>
                            <p style="font-size: 0.9rem; color: #777; margin-top: 15px;">
                                <strong>Recomendaciones:</strong><br>
                                1. Verifica que el nombre esté escrito correctamente<br>
                                2. Intenta con el formato: NOMBRE APELLIDO APELLIDO<br>
                                3. Asegúrate de estar registrado en el sistema GDB
                            </p>
                            <p style="font-size: 0.9rem; color: #777; margin-top: 10px;">
                                <strong>Nota:</strong> Si eres nuevo miembro, contacta a la directiva para registrarte.
                            </p>
                        </div>
                    `;
                    resultadoContainer.className = 'resultado-container';
                    resultadoContainer.style.display = 'block';
                    verificarActions.style.display = 'none';
                    return;
                }
                
                // Verificar estado basado en fecha (USANDO LA MISMA LÓGICA QUE EL ADMIN)
                const estadoActual = miembro.estado && miembro.estado !== 'verificar' 
                    ? miembro.estado 
                    : verificarEstadoPorFecha(miembro.ultimaActualizacion);
                
                const esAlDia = estadoActual === 'al-dia';
                const estadoTexto = esAlDia ? 'Al Día' : 'Deudor';
                const estadoClase = esAlDia ? 'resultado-al-dia' : 'resultado-deudor';
                const icono = esAlDia ? 'fa-check-circle' : 'fa-exclamation-circle';
                const iconoClase = esAlDia ? 'al-dia-icon' : 'deudor-icon';
                
                // Obtener información de la fecha
                const hoy = new Date();
                const diaDelMes = hoy.getDate();
                const mesActual = hoy.getMonth() + 1;
                let mensajeRenovacion = '';
                
                if (diaDelMes >= 14 && !esAlDia) {
                    mensajeRenovacion = `
                        <div style="margin-top: 15px; padding: 12px; border-radius: 5px; background-color: #fff3cd; border-left: 4px solid #ffc107;">
                            <p style="margin: 0; color: #856404;">
                                <i class="fas fa-calendar-exclamation"></i>
                                <strong>Recordatorio:</strong> La membresía se renovó automáticamente el 14/${mesActual}. 
                                Para regularizar tu estado, realiza el pago y envía el comprobante.
                            </p>
                        </div>
                    `;
                } else if (diaDelMes >= 10 && diaDelMes < 14 && esAlDia) {
                    mensajeRenovacion = `
                        <div style="margin-top: 15px; padding: 12px; border-radius: 5px; background-color: #e3f2fd; border-left: 4px solid #2196f3;">
                            <p style="margin: 0; color: #0c5460;">
                                <i class="fas fa-calendar-check"></i>
                                <strong>Próxima renovación:</strong> Tu membresía se renovará automáticamente el 14/${mesActual}. 
                                Asegúrate de realizar el pago antes de esa fecha.
                            </p>
                        </div>
                    `;
                }
                
                // Determinar qué información de contacto mostrar
                let contactoInfo = '';
                if (miembro.tipo === 'directiva') {
                    contactoInfo = miembro.departamento || 'Beni';
                } else {
                    contactoInfo = miembro.telefono || 'No registrado';
                }
                
                resultadoContainer.innerHTML = `
                    <div class="resultado-header">
                        <div class="resultado-icon ${iconoClase}">
                            <i class="fas ${icono}"></i>
                        </div>
                        <div class="resultado-info">
                            <h3>
                                ${miembro.nombre}
                                <span class="tipo-badge tipo-${miembro.tipo}">
                                    ${miembro.tipo === 'directiva' ? 'Directiva' : 'Delegado'}
                                </span>
                            </h3>
                            <p><strong>Estado:</strong> ${estadoTexto}</p>
                        </div>
                    </div>
                    
                    <div class="resultado-details">
                        <div class="detail-item">
                            <div class="detail-label">Cargo/Comisión</div>
                            <div class="detail-value">${miembro.cargo}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">${miembro.tipo === 'directiva' ? 'Departamento' : 'Teléfono'}</div>
                            <div class="detail-value">${contactoInfo}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Última Actualización</div>
                            <div class="detail-value">${miembro.ultimaActualizacion}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Estado de Membresía</div>
                            <div class="detail-value"><strong>${estadoTexto}</strong></div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 25px; padding: 15px; border-radius: 5px; background-color: ${esAlDia ? 'rgba(46, 125, 50, 0.1)' : 'rgba(211, 47, 47, 0.1)'};">
                        <p style="margin: 0; color: ${esAlDia ? '#2e7d32' : '#d32f2f'}; font-weight: 500;">
                            <i class="fas ${esAlDia ? 'fa-check' : 'fa-exclamation-triangle'}"></i>
                            ${esAlDia ?
                            '¡Tu membresía está al día! Gracias por mantenerte al corriente con los pagos.' :
                            'Tu membresía está pendiente de pago. Regulariza tu situación lo antes posible.'}
                        </p>
                    </div>
                    
                    ${mensajeRenovacion}
                `;
                
                resultadoContainer.className = `resultado-container ${estadoClase}`;
                resultadoContainer.style.display = 'block';
                
                // Mostrar acciones si está en deudor
                verificarActions.style.display = !esAlDia ? 'block' : 'none';
            });
        });
    </script>
</body>
</html>